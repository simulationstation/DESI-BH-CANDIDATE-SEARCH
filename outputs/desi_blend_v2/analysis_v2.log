======================================================================
DESI BLEND-AWARE RV RE-MEASUREMENT v2
======================================================================

Target: Gaia DR3 3802130935635096832
DESI TARGETID: 39627745210139276

Neighbor: sep=0.688", ΔG=2.21
Expected flux ratio: 0.130
Loading PHOENIX templates...
  M0 template: 380001 pixels, λ=[5500, 9300] Å
  M5 template: 380001 pixels

Loading DESI spectra...
  Epoch1: coadd_20268_20211219_p2.fits
    SNR ~ 40.2, 3500 pixels
  Epoch2: coadd_24976_20220125_p7.fits
    SNR ~ 26.8, 3500 pixels
  Epoch3: coadd_23137_20220127_p0.fits
    SNR ~ 31.1, 3500 pixels

======================================================================
PART 1: SINGLE-TEMPLATE (M0) RV FITTING
======================================================================

Epoch1 (Catalog RV: -86.4 km/s)
  Fitted RV: -105.8 ± 0.0 km/s
  Amplitude: 0.963
  χ²/dof: 114853.4/2640 = 43.51

Epoch2 (Catalog RV: +59.7 km/s)
  Fitted RV: +60.9 ± 0.0 km/s
  Amplitude: 0.961
  χ²/dof: 52973.8/2596 = 20.41

Epoch3 (Catalog RV: +25.8 km/s)
  Fitted RV: +38.9 ± 0.0 km/s
  Amplitude: 0.966
  χ²/dof: 69856.6/2661 = 26.25

--- Single-Template RV Comparison ---
Epoch         Catalog       Fitted       Diff
Epoch1          -86.4     -105.8±0.0      -19.4
Epoch2          +59.7      +60.9±0.0       +1.3
Epoch3          +25.8      +38.9±0.0      +13.1

Catalog RV swing: 146.1 km/s
Fitted RV swing:  166.8 km/s

======================================================================
PART 2: TWO-TEMPLATE (M0+M5) BLEND FITS
======================================================================

Flux ratio prior: b ~ lognormal(0.130, σ_log=0.5)
  Effective range: 0.048 to 0.355

Epoch1
  v1 (primary): -131.6 ± 0.0 km/s
  v2 (neighbor): -54.8 km/s
  Amplitude A: 0.948
  Flux ratio b: 0.010 (expected 0.130)
  χ²/dof: 123139.3/2638 = 46.68

Epoch2
  v1 (primary): +108.4 ± 0.0 km/s
  v2 (neighbor): +68.3 km/s
  Amplitude A: 0.946
  Flux ratio b: 0.010 (expected 0.130)
  χ²/dof: 56891.8/2594 = 21.93

Epoch3
  v1 (primary): +60.8 ± 0.0 km/s
  v2 (neighbor): +29.0 km/s
  Amplitude A: 0.953
  Flux ratio b: 0.010 (expected 0.130)
  χ²/dof: 75459.5/2659 = 28.38

--- Model Comparison (per-epoch) ---
Epoch         χ²_single     χ²_blend        Δχ²       ΔBIC
Epoch1         114853.4     123139.3    -8285.9    +8301.7
Epoch2          52973.8      56891.8    -3918.1    +3933.8
Epoch3          69856.6      75459.5    -5602.9    +5618.7

======================================================================
PART 3: CROSS-EPOCH CONSTANT-v2 MODEL
======================================================================

Testing: v2 (neighbor) is constant across all epochs
         v1 (primary) varies freely per epoch

Results:
  v2 (shared): -16.5 km/s
  Flux ratio b: 0.010
  Epoch1: v1=-50.2 km/s, A=0.951
  Epoch2: v1=+77.4 km/s, A=0.948
  Epoch3: v1=-2.8 km/s, A=0.952

  Total χ²: 262233.8
  χ²/dof: 33.22

  For comparison:
    Sum of single-template χ²: 237683.7
    Δχ² (single - const_v2): -24550.1

======================================================================
VERDICT
======================================================================

1. Single-template RV vs catalog:
   Max |Δ|: 19.4 km/s, RMS: 13.5 km/s
   → INCONCLUSIVE: Moderate differences

2. Two-template model preference (ΔBIC < -6):
   Epochs preferring blend: 0/3
   → PASS: Single-template sufficient for all epochs

3. Fitted flux ratios (expected ~0.130):
   Mean b: 0.010 ± 0.000
   → INCONSISTENT with known neighbor flux ratio

4. Constant-v2 (background neighbor) model:
   Δχ² improvement vs single-template: -24550.1
   → NOT strongly favored

5. Physics check: Can ~13% blend explain 146 km/s swing?
   Max blend-induced shift (b=0.13, v_offset=200): ~26 km/s
   Observed catalog swing: 146 km/s
   → NO: Blend cannot explain the amplitude

======================================================================
OVERALL VERDICT
======================================================================

Verdict Summary:
  single_template_consistency: INCONCLUSIVE
  two_template_preference: PASS
  flux_ratio_physical: INCONSISTENT
  constant_v2_model: NOT_FAVORED
  blend_explains_swing: NO

**OVERALL: ROBUST**

DESI RV swing is ROBUST: the ~13% neighbor blend cannot explain the 146 km/s amplitude.

======================================================================
GENERATING FIGURES
======================================================================

Generating chi2_vs_v_by_epoch.png...
Generating rv_by_method_v2.png...
Generating two_template_residuals_v2.png...
Generating ccf_peak_shapes_v2.png...
All figures generated.

======================================================================
SAVING OUTPUTS
======================================================================
Saved: /home/primary/DESI-BH-CANDIDATE-SEARCH/outputs/desi_blend_v2/desi_epoch_rv_refit_v2.json
Traceback (most recent call last):
  File "/home/primary/DESI-BH-CANDIDATE-SEARCH/scripts/desi_blend_aware_rv_v2.py", line 1273, in <module>
    main()
  File "/home/primary/DESI-BH-CANDIDATE-SEARCH/scripts/desi_blend_aware_rv_v2.py", line 1081, in main
    json.dump(model_compare, f, indent=2, default=json_safe)
  File "/usr/lib/python3.12/json/__init__.py", line 179, in dump
    for chunk in iterable:
  File "/usr/lib/python3.12/json/encoder.py", line 432, in _iterencode
    yield from _iterencode_dict(o, _current_indent_level)
  File "/usr/lib/python3.12/json/encoder.py", line 406, in _iterencode_dict
    yield from chunks
  File "/usr/lib/python3.12/json/encoder.py", line 326, in _iterencode_list
    yield from chunks
  File "/usr/lib/python3.12/json/encoder.py", line 406, in _iterencode_dict
    yield from chunks
  File "/usr/lib/python3.12/json/encoder.py", line 440, in _iterencode
    yield from _iterencode(o, _current_indent_level)
  File "/usr/lib/python3.12/json/encoder.py", line 437, in _iterencode
    raise ValueError("Circular reference detected")
ValueError: Circular reference detected
